<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scan Check + Putaway</title>

<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#f7f9fc;margin:0;padding:20px}
  .card{background:#fff;border-radius:12px;padding:16px;margin:0 0 14px 0;max-width:1100px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  h1{margin:0 0 6px}
  .sub{font-size:13px;color:#555;margin:0 0 14px;line-height:1.35}
  input{font-size:22px;padding:10px;width:100%;border-radius:10px;border:1px solid #ccc;box-sizing:border-box}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800;vertical-align:middle}
  .good{background:#dcfce7;color:#166534}
  .bad{background:#fee2e2;color:#7f1d1d}
  button{padding:8px 12px;border-radius:10px;border:1px solid #cbd5e1;font-weight:800;cursor:pointer;background:#fff}
  button.primary{background:#2563eb;border-color:#2563eb;color:#fff}
  button:disabled{opacity:.5;cursor:not-allowed}
  button:active{transform:translateY(1px)}
  .meta{margin-top:8px;font-size:13px;color:#444;line-height:1.35}
  .meta strong{color:#111}
  code{background:#f3f4f6;padding:1px 6px;border-radius:6px}

  .topnav{
    display:flex; gap:10px; align-items:center;
    padding:10px 12px; margin:0 0 14px 0;
    background:#fff; border:1px solid #e2e8f0;
    border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.06);
    max-width:1100px;
  }
  .topnav a{text-decoration:none;font-weight:900;color:#0f172a;padding:8px 10px;border-radius:10px}
  .topnav a:hover{background:#f1f5f9}
  .topnav .active{background:#e2e8f0}

  .grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
  @media (max-width:800px){ .grid{grid-template-columns:1fr;} }
  .kpi{border:1px solid #e2e8f0;border-radius:12px;padding:14px;background:#f8fafc}
  .kpi .label{font-size:13px;color:#475569;font-weight:900;margin-bottom:6px}
  .kpi .value{font-size:60px;line-height:1;font-weight:1000;letter-spacing:1px}
  .kpi .hint{margin-top:6px;font-size:12px;color:#64748b}

  .binline{font-size:18px;font-weight:900;margin:10px 0 0}
  .titleline{font-size:16px;font-weight:900;margin:2px 0 0;color:#0f172a}
  .smallline{font-size:13px;color:#475569;margin-top:6px}

  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
  tbody tr:nth-child(even){background:#f9fafb}

  .formRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;font-weight:900;color:#475569}
  .field input{font-size:16px;padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;width:140px}
  .field input.wide{width:200px}

  .toast{position:fixed;left:20px;bottom:20px;background:#0f172a;color:#fff;
    padding:10px 12px;border-radius:12px;font-weight:800;box-shadow:0 8px 20px rgba(0,0,0,.18);display:none;z-index:9999}
</style>
</head>

<body>

<div id="toast" class="toast"></div>

<nav class="topnav">
  <a href="./picklefinder.html">ü•í PickleFinder</a>
  <a href="./pickle24.html">üì¶ Pickle24</a>
  <a class="active" href="./putaway.html">üßæ Scan Check + Putaway</a>
  <a href="./index.html">üè† Home</a>
</nav>

<h1>Scan Check + Putaway</h1>
<p class="sub">
  Scan an item to see <strong>Needed to Max</strong> for Plymouth & Green Harbor. Each successful scan is auto-added to Putaway.
  Use <strong>Queue Update</strong> to build an Updates CSV for min/max/weight.
</p>

<div class="card">
  <div id="status"><span class="badge bad">Not loaded</span> Waiting‚Ä¶</div>
  <div id="meta" class="meta"></div>

  <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
    <button type="button" onclick="loadCSV()">Reload from site</button>
    <button type="button" onclick="openCSV()">Open CSV</button>
    <button type="button" onclick="clearPutaway()">Clear Putaway List</button>
    <button type="button" class="primary" onclick="downloadPutaway()">Download Putaway CSV</button>
    <button id="updatesBtn" type="button" class="primary" onclick="downloadUpdates()">
      Download Updates CSV
    </button>
  </div>

  <div class="sub" id="summary" style="margin-top:10px"></div>
</div>

<div class="card">
  <input id="scan" placeholder="Scan barcode or SKU and press Enter" autofocus>
  <div id="result" style="margin-top:12px"></div>
</div>

<div class="card">
  <div style="font-weight:1000;margin-bottom:6px">Putaway List</div>
  <table>
    <thead><tr><th>Time</th><th>Bin</th><th>Barcode</th><th>Title</th></tr></thead>
    <tbody id="putawayTable"></tbody>
  </table>
</div>

<div class="card">
  <div style="font-weight:1000;margin-bottom:6px">Queued Updates Preview</div>
  <div class="sub">If Queue Update worked, rows will appear here immediately.</div>
  <table>
    <thead>
      <tr>
        <th>Barcode</th><th>SKU</th><th>Min PLY</th><th>Max PLY</th><th>Min GH</th><th>Max GH</th><th>Weight</th>
      </tr>
    </thead>
    <tbody id="updatesTable"></tbody>
  </table>
</div>

<script>
  const CSV_URL = './pickle-data.csv';

  // Headers in your export
  const COL_BARCODE = 'Variant Barcode';
  const COL_SKU     = 'Variant SKU';
  const COL_TITLE   = 'Title';
  const COL_BIN     = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

  const COL_PLY_ON  = 'Inventory Available: Plymouth';
  const COL_GH_ON   = 'Inventory Available: Green Harbor';
  const COL_PLY_MAX = 'Variant Metafield: custom.maxply [number_integer]';
  const COL_GH_MAX  = 'Variant Metafield: custom.maxgh [number_integer]';

  // Updates export headers
  const COL_PLY_MIN = 'Variant Metafield: custom.minply [number_integer]';
  const COL_GH_MIN  = 'Variant Metafield: custom.mingh [number_integer]';
  // ‚ö†Ô∏è If your weight header differs, change this:
  const COL_WEIGHT  = 'Variant Metafield: custom.weight [number_decimal]';

  let rows = [];
  let putaway = [];
  let updates = new Map(); // key -> {barcode, sku, minply, maxply, mingh, maxgh, weight}

  const statusEl = document.getElementById('status');
  const metaEl   = document.getElementById('meta');
  const resultEl = document.getElementById('result');
  const scanEl   = document.getElementById('scan');
  const putawayTableEl = document.getElementById('putawayTable');
  const updatesTableEl = document.getElementById('updatesTable');
  const summaryEl = document.getElementById('summary');

  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(toast._timer);
    toast._timer = setTimeout(()=>t.style.display='none', 1800);
  }

  function esc(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function setStatus(ok, msg){
    statusEl.innerHTML = `<span class="badge ${ok ? 'good' : 'bad'}">${ok ? 'Loaded' : 'Failed'}</span> ${msg}`;
  }
  function setMeta(html){ metaEl.innerHTML = html || ''; }
  function fmtDate(d){ try{ return new Date(d).toLocaleString(); } catch { return String(d||''); } }

  function n(v){
    const s = String(v ?? '').replace(/[^0-9.\-]/g,'').trim();
    if(!s) return 0;
    const x = Number(s);
    return Number.isFinite(x) ? x : 0;
  }

  // CSV parsing (quoted commas)
  function detectDelimiter(text) {
    const firstLine = (text.split(/\r?\n/).find(l => l.trim() !== '') || '');
    const candidates = [',',';','\t','|'];
    let best = ',', bestCount = -1;
    for (const d of candidates) {
      const c = firstLine.split(d).length;
      if (c > bestCount) { bestCount = c; best = d; }
    }
    return best;
  }
  function parseCSV(text, delimiter) {
    const out = [];
    let i = 0, field = '', row = [], inQuotes = false;

    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

    while (i < text.length) {
      const c = text[i];
      if (c === '"') {
        if (inQuotes && text[i+1] === '"') { field += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (c === delimiter && !inQuotes) {
        row.push(field); field = '';
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (field !== '' || row.length) { row.push(field); out.push(row); row = []; field = ''; }
        if (c === '\r' && text[i+1] === '\n') i++;
      } else {
        field += c;
      }
      i++;
    }
    if (field !== '' || row.length) { row.push(field); out.push(row); }
    return out;
  }
  function toObjects(matrix) {
    if (!matrix.length) return [];
    const headers = (matrix[0] || []).map(h => String(h ?? '').trim());
    const objects = [];
    for (let r = 1; r < matrix.length; r++) {
      const line = matrix[r];
      if (!line || !line.length) continue;
      if (line.join('').trim() === '') continue;
      const obj = {};
      for (let c = 0; c < headers.length; c++) obj[headers[c]] = (line[c] ?? '').trim();
      objects.push(obj);
    }
    return objects;
  }

  async function loadCSV(){
    setStatus(false, 'Loading‚Ä¶');
    setMeta('');
    rows = [];

    try{
      const url = CSV_URL + '?v=' + Date.now();
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);

      const lastModified = res.headers.get('last-modified');
      const etag = res.headers.get('etag');

      const text = await res.text();
      const delim = detectDelimiter(text);
      rows = toObjects(parseCSV(text, delim));

      setStatus(true, `Parsed ${rows.length} rows`);
      setMeta(`
        <div><strong>CSV file:</strong> <code>${esc(CSV_URL)}</code></div>
        <div><strong>CSV Last Updated (server):</strong> ${lastModified ? fmtDate(lastModified) : '<span style="color:#7f1d1d;">Unknown</span>'}</div>
        <div><strong>Loaded at (this device):</strong> ${new Date().toLocaleString()}</div>
        ${etag ? `<div><strong>ETag:</strong> <code>${esc(etag)}</code></div>` : ''}
      `);
      toast('CSV loaded');
    }catch(e){
      setStatus(false, `Couldn‚Äôt load <code>${esc(CSV_URL)}</code> ‚Äî ${esc(e.message)}`);
      setMeta(`<div style="color:#7f1d1d;"><strong>Tip:</strong> Confirm <code>${esc(CSV_URL)}</code> exists in the repo root.</div>`);
    }
    updateSummary();
  }

  function openCSV(){ window.open(CSV_URL, '_blank', 'noopener'); }

  function updateSummary(){
    summaryEl.innerHTML =
      `<strong>Putaway scans:</strong> ${putaway.length} &nbsp; | &nbsp; <strong>Updates queued:</strong> ${updates.size}`;
  }

  scanEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const q = scanEl.value.trim();
      scanEl.value = '';
      lookup(q);
      setTimeout(()=>scanEl.focus(), 50);
    }
  });

  function lookup(q){
    if(!rows.length){
      resultEl.innerHTML = `<div class="badge bad">Not ready</div> Load the CSV first.`;
      return;
    }

    const m = rows.find(r =>
      (r[COL_BARCODE] && r[COL_BARCODE] === q) ||
      (r[COL_SKU] && r[COL_SKU] === q)
    );

    if(!m){
      resultEl.innerHTML = `<div class="badge bad">Not found</div>`;
      return;
    }

    const bin = (m[COL_BIN] || '‚Äî').trim();
    const title = (m[COL_TITLE] || '').trim();
    const barcode = (m[COL_BARCODE] || '').trim();
    const sku = (m[COL_SKU] || '').trim();

    const plyOn  = n(m[COL_PLY_ON]);
    const ghOn   = n(m[COL_GH_ON]);
    const plyMax = n(m[COL_PLY_MAX]);
    const ghMax  = n(m[COL_GH_MAX]);

    const plyNeed = Math.max(plyMax - plyOn, 0);
    const ghNeed  = Math.max(ghMax - ghOn, 0);

    // current values for edit panel
    const curMinPly = n(m[COL_PLY_MIN]);
    const curMaxPly = n(m[COL_PLY_MAX]);
    const curMinGh  = n(m[COL_GH_MIN]);
    const curMaxGh  = n(m[COL_GH_MAX]);
    const curWeight = (m[COL_WEIGHT] ?? '').toString().trim();

    // Auto add to putaway on success
    addPutaway(bin, barcode, title);

    resultEl.innerHTML = `
      <div class="grid">
        <div class="kpi">
          <div class="label">Plymouth Needed to Max</div>
          <div class="value">${plyNeed}</div>
          <div class="hint">Max ${plyMax} ‚Ä¢ On hand ${plyOn}</div>
        </div>
        <div class="kpi">
          <div class="label">Green Harbor Needed to Max</div>
          <div class="value">${ghNeed}</div>
          <div class="hint">Max ${ghMax} ‚Ä¢ On hand ${ghOn}</div>
        </div>
      </div>

      <div class="binline">WH Bin: <span style="font-weight:1000">${esc(bin)}</span></div>
      <div class="titleline">${esc(title)}</div>
      <div class="smallline"><strong>Barcode:</strong> ${esc(barcode)} &nbsp; | &nbsp; <strong>SKU:</strong> ${esc(sku)}</div>

      <div class="card" style="margin-top:12px;max-width:none;background:#f8fafc;border:1px solid #e2e8f0">
        <div style="font-weight:1000;margin-bottom:6px">Update Min/Max/Weight</div>
        <div class="sub" style="margin:0 0 10px 0">Edit values, click <strong>Queue Update</strong>. You‚Äôll see it appear in ‚ÄúQueued Updates Preview‚Äù.</div>

        <div class="formRow">
          <div class="field"><label>Min PLY</label><input id="u_minply" value="${curMinPly}" inputmode="numeric"></div>
          <div class="field"><label>Max PLY</label><input id="u_maxply" value="${curMaxPly}" inputmode="numeric"></div>
          <div class="field"><label>Min GH</label><input id="u_mingh" value="${curMinGh}" inputmode="numeric"></div>
          <div class="field"><label>Max GH</label><input id="u_maxgh" value="${curMaxGh}" inputmode="numeric"></div>
          <div class="field"><label>Weight</label><input id="u_weight" class="wide" value="${esc(curWeight)}" placeholder="e.g., 2.5"></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <button type="button" class="primary" onclick="queueUpdate(${JSON.stringify(barcode)},${JSON.stringify(sku)})">Queue Update</button>
          <button type="button" onclick="removeUpdate(${JSON.stringify(barcode)},${JSON.stringify(sku)})">Remove Update</button>
        </div>
      </div>
    `;
  }

  function addPutaway(bin, barcode, title){
    const time = new Date();
    putaway.push({time, bin, barcode, title});

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(time.toLocaleTimeString())}</td>
      <td>${esc(bin)}</td>
      <td>${esc(barcode)}</td>
      <td>${esc(title)}</td>
    `;
    putawayTableEl.prepend(tr);
    updateSummary();
  }

  function clearPutaway(){
    putaway = [];
    putawayTableEl.innerHTML = '';
    resultEl.innerHTML = '';
    updateSummary();
    scanEl.focus();
  }

  function queueUpdate(barcode, sku){
    const minply = document.getElementById('u_minply')?.value ?? '';
    const maxply = document.getElementById('u_maxply')?.value ?? '';
    const mingh  = document.getElementById('u_mingh')?.value ?? '';
    const maxgh  = document.getElementById('u_maxgh')?.value ?? '';
    const weight = document.getElementById('u_weight')?.value ?? '';

    const key = `${barcode}|${sku}`;
    updates.set(key, { barcode, sku, minply, maxply, mingh, maxgh, weight });

    renderUpdatesPreview();
    updateSummary();
    toast('Update queued');
  }

  function removeUpdate(barcode, sku){
    updates.delete(`${barcode}|${sku}`);
    renderUpdatesPreview();
    updateSummary();
    toast('Update removed');
  }

  function renderUpdatesPreview(){
    updatesTableEl.innerHTML = '';
    for(const u of updates.values()){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(u.barcode)}</td>
        <td>${esc(u.sku)}</td>
        <td>${esc(u.minply)}</td>
        <td>${esc(u.maxply)}</td>
        <td>${esc(u.mingh)}</td>
        <td>${esc(u.maxgh)}</td>
        <td>${esc(u.weight)}</td>
      `;
      updatesTableEl.appendChild(tr);
    }
  }

  function downloadPutaway(){
    if(!putaway.length){
      setStatus(false, 'No putaway scans to export');
      return;
    }
    const sorted = [...putaway].sort((a,b) =>
      String(a.bin).localeCompare(String(b.bin), undefined, {numeric:true, sensitivity:'base'})
    );
    const rowsOut = [['bin','barcode','title']];
    for(const s of sorted){
      const bc = s.barcode ? `="${String(s.barcode).replace(/"/g,'""')}"` : '';
      rowsOut.push([s.bin || '', bc, s.title || '']);
    }
    const csv = rowsOut.map(r => r.map(csvCell).join(',')).join('\n');
    downloadText(csv, `putaway_report_${new Date().toISOString().slice(0,10)}.csv`);
    setStatus(true, 'Downloaded Putaway Report CSV');
  }

  function downloadUpdates(){
    if(updates.size === 0){
      setStatus(false, 'No updates queued. Scan an item ‚Üí edit values ‚Üí Queue Update.');
      return;
    }

    const header = ['Variant Barcode','Variant SKU', COL_PLY_MIN, COL_PLY_MAX, COL_GH_MIN, COL_GH_MAX, COL_WEIGHT];
    const out = [header];

    for(const u of updates.values()){
      const bc = u.barcode ? `="${String(u.barcode).replace(/"/g,'""')}"` : '';
      out.push([bc, u.sku || '', u.minply ?? '', u.maxply ?? '', u.mingh ?? '', u.maxgh ?? '', u.weight ?? '']);
    }

    const csv = out.map(r => r.map(csvCell).join(',')).join('\n');
    downloadText(csv, `pickle_updates_${new Date().toISOString().slice(0,10)}.csv`);
    setStatus(true, 'Downloaded Updates CSV');
  }

  function csvCell(v){
    const s = v == null ? '' : String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }

  // Stronger iOS/Safari download fallback:
  // 1) click <a download>
  // 2) if Safari blocks, open blob URL in new tab so user can "Share ‚Üí Save to Files"
  function downloadText(text, filename){
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.rel = 'noopener';
    document.body.appendChild(a);

    try{
      a.click();
      toast('Download started');
    }catch(e){
      // fallback
      window.open(url, '_blank', 'noopener');
      toast('Opened file (Save/Share)');
    }finally{
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }
  }

  // boot
  loadCSV();
  updateSummary();
</script>

</body>
</html>
