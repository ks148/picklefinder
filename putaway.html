<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scan Check + Putaway</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#f7f9fc;margin:0;padding:20px}
  .card{background:#fff;border-radius:12px;padding:16px;margin:0 0 14px 0;max-width:1100px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  h1{margin:0 0 6px}
  .sub{font-size:13px;color:#555;margin:0 0 14px;line-height:1.35}
  input{font-size:22px;padding:10px;width:100%;border-radius:10px;border:1px solid #ccc;box-sizing:border-box}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800;vertical-align:middle}
  .good{background:#dcfce7;color:#166534}
  .bad{background:#fee2e2;color:#7f1d1d}
  button{padding:8px 12px;border-radius:10px;border:1px solid #cbd5e1;font-weight:800;cursor:pointer;background:#fff}
  button.primary{background:#2563eb;border-color:#2563eb;color:#fff}
  button:disabled{opacity:.5;cursor:not-allowed}
  button:active{transform:translateY(1px)}
  .meta{margin-top:8px;font-size:13px;color:#444;line-height:1.35}
  .meta strong{color:#111}
  code{background:#f3f4f6;padding:1px 6px;border-radius:6px}

  .topnav{
    display:flex; gap:10px; align-items:center;
    padding:10px 12px; margin:0 0 14px 0;
    background:#fff; border:1px solid #e2e8f0;
    border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.06);
    max-width:1100px; flex-wrap:wrap;
  }
  .topnav a{text-decoration:none;font-weight:900;color:#0f172a;padding:8px 10px;border-radius:10px}
  .topnav a:hover{background:#f1f5f9}

  .grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
  @media (max-width:800px){ .grid{grid-template-columns:1fr;} }
  .kpi{border:1px solid #e2e8f0;border-radius:12px;padding:14px;background:#f8fafc}
  .kpi .label{font-size:13px;color:#475569;font-weight:900;margin-bottom:6px}
  .kpi .value{font-size:60px;line-height:1;font-weight:1000;letter-spacing:1px}
  .kpi .hint{margin-top:6px;font-size:12px;color:#64748b}

  .binline{font-size:18px;font-weight:900;margin:10px 0 0}
  .titleline{font-size:16px;font-weight:900;margin:2px 0 0;color:#0f172a}
  .smallline{font-size:13px;color:#475569;margin-top:6px}

  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
  tbody tr:nth-child(even){background:#f9fafb}

  .formRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;font-weight:900;color:#475569}
  .field input{font-size:16px;padding:8px 10px;border-radius:10px;border:1px solid #cbd5e1;width:140px}
  .field input.wide{width:220px}
  .field input.bin{width:260px}

  .toast{position:fixed;left:20px;bottom:20px;background:#0f172a;color:#fff;
    padding:10px 12px;border-radius:12px;font-weight:900;box-shadow:0 8px 20px rgba(0,0,0,.18);display:none;z-index:9999}
  .debug{font-size:12px;color:#334155;margin-top:8px}
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<!-- NAV: paste the same nav into every tool page -->
<nav class="topnav">
  <a href="./index.html">üè† Home</a>
  <a href="./picklefinder.html">ü•í PickleFinder</a>
  <a href="./pickle24.html">üì¶ Pickle24</a>
  <a href="./putaway.html">üßæ Scan + Putaway</a>
</nav>

<h1>Scan Check + Putaway</h1>
<p class="sub">
  Scan an item to see <strong>Needed to Max</strong> for Plymouth &amp; Green Harbor. Every successful scan is auto-added to Putaway.
  Edit values ‚Üí <strong>Queue Update</strong> ‚Üí exports contain only <strong>Variant ID</strong> + changed fields (Min/Max, Weight, Bin).
</p>

<div class="card">
  <div id="status"><span class="badge bad">Not loaded</span> Waiting‚Ä¶</div>
  <div id="meta" class="meta"></div>

  <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
    <button id="btnReload" type="button">Reload from site</button>
    <button id="btnOpen" type="button">Open CSV</button>
    <button id="btnClearPutaway" type="button">Clear Putaway</button>
    <button id="btnPutaway" type="button" class="primary">Download Putaway CSV</button>

    <button id="btnBin" type="button" class="primary" disabled>Download Bin Updates CSV</button>
    <button id="btnWeight" type="button" class="primary" disabled>Download Weight Updates CSV</button>
    <button id="btnMinMax" type="button" class="primary" disabled>Download Min/Max Updates CSV</button>
  </div>

  <div class="sub" id="summary" style="margin-top:10px"></div>
  <div class="debug" id="debugLine"></div>
</div>

<div class="card">
  <input id="scan" placeholder="Scan barcode or SKU and press Enter" autofocus>
  <div id="result" style="margin-top:12px"></div>
</div>

<div class="card">
  <div style="font-weight:1000;margin-bottom:6px">Putaway List</div>
  <table>
    <thead><tr><th>Time</th><th>Bin</th><th>Barcode</th><th>Title</th></tr></thead>
    <tbody id="putawayTable"></tbody>
  </table>
</div>

<div class="card">
  <div style="font-weight:1000;margin-bottom:6px">Queued Updates Preview</div>
  <div class="sub">Shows Variant ID + only the fields you typed.</div>
  <table>
    <thead>
      <tr>
        <th>Variant ID</th>
        <th>New WH Bin</th>
        <th>Min PLY</th><th>Max PLY</th><th>Min GH</th><th>Max GH</th>
        <th>Variant Weight</th>
      </tr>
    </thead>
    <tbody id="updatesTable"></tbody>
  </table>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const CSV_URL = './pickle-data.csv';

  const COL_VARIANT_ID = 'Variant ID';
  const COL_BARCODE    = 'Variant Barcode';
  const COL_SKU        = 'Variant SKU';
  const COL_TITLE      = 'Title';

  // BIN column (confirmed)
  const COL_BIN        = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

  // On-hand + max fields for "needed to max"
  const COL_PLY_ON     = 'Inventory Available: Plymouth';
  const COL_GH_ON      = 'Inventory Available: Green Harbor';
  const COL_PLY_MAX    = 'Variant Metafield: custom.maxply [number_integer]';
  const COL_GH_MAX     = 'Variant Metafield: custom.maxgh [number_integer]';

  // Min/Max metafields to update
  const COL_PLY_MIN    = 'Variant Metafield: custom.minply [number_integer]';
  const COL_GH_MIN     = 'Variant Metafield: custom.mingh [number_integer]';

  // Weight column (confirmed)
  const COL_WEIGHT     = 'Variant Weight';

  // =========================
  // STATE
  // =========================
  let rows = [];
  let putaway = [];

  // updates keyed by Variant ID:
  // variantId -> { variantId, bin?, minply?, maxply?, mingh?, maxgh?, weight? }
  let updates = new Map();

  let activeVariantId = '';
  let activeBarcode = '';
  let activeSku = '';

  // =========================
  // DOM
  // =========================
  const statusEl = document.getElementById('status');
  const metaEl = document.getElementById('meta');
  const summaryEl = document.getElementById('summary');
  const debugEl = document.getElementById('debugLine');
  const scanEl = document.getElementById('scan');
  const resultEl = document.getElementById('result');
  const putawayTableEl = document.getElementById('putawayTable');
  const updatesTableEl = document.getElementById('updatesTable');

  const btnReload = document.getElementById('btnReload');
  const btnOpen = document.getElementById('btnOpen');
  const btnClearPutaway = document.getElementById('btnClearPutaway');
  const btnPutaway = document.getElementById('btnPutaway');
  const btnBin = document.getElementById('btnBin');
  const btnWeight = document.getElementById('btnWeight');
  const btnMinMax = document.getElementById('btnMinMax');

  // =========================
  // HELPERS
  // =========================
  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(toast._timer);
    toast._timer = setTimeout(()=>t.style.display='none', 1800);
  }

  function esc(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function setStatus(ok, msg){
    statusEl.innerHTML = `<span class="badge ${ok ? 'good' : 'bad'}">${ok ? 'Loaded' : 'Failed'}</span> ${msg}`;
  }

  function setMeta(html){ metaEl.innerHTML = html || ''; }

  function n(v){
    const s = String(v ?? '').replace(/[^0-9.\-]/g,'').trim();
    if(!s) return 0;
    const x = Number(s);
    return Number.isFinite(x) ? x : 0;
  }

  function csvCell(v){
    const s = v == null ? '' : String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }

  function updateSummary(){
    let weightCount = 0, minmaxCount = 0, binCount = 0;
    for(const u of updates.values()){
      if(u.weight != null) weightCount++;
      if(u.bin != null) binCount++;
      if(u.minply!=null || u.maxply!=null || u.mingh!=null || u.maxgh!=null) minmaxCount++;
    }

    summaryEl.innerHTML =
      `<strong>Putaway scans:</strong> ${putaway.length} &nbsp; | &nbsp; <strong>Updates queued:</strong> ${updates.size}
       &nbsp; (Bin: ${binCount}, Weight: ${weightCount}, Min/Max: ${minmaxCount})`;

    btnBin.disabled = (binCount === 0);
    btnWeight.disabled = (weightCount === 0);
    btnMinMax.disabled = (minmaxCount === 0);
  }

  // iPad-friendly save:
  // - Uses Share Sheet with a File when possible
  // - Falls back to opening a new tab (Share ‚Üí Save to Files)
  async function saveCSV(csvText, filename){
    const blob = new Blob([csvText], {type:'text/csv;charset=utf-8;'});
    const file = new File([blob], filename, {type:'text/csv'});

    try{
      if(navigator.canShare && navigator.canShare({ files: [file] })){
        await navigator.share({ files: [file], title: filename, text: 'Pickle Tools export' });
        toast('Share Sheet opened (Save to Files)');
        return;
      }
    }catch(e){
      // fall through
    }

    const url = URL.createObjectURL(blob);
    const w = window.open(url, '_blank', 'noopener');
    toast(w ? 'Opened in new tab (Share ‚Üí Save to Files)' : 'Popup blocked ‚Äî allow popups then retry');
    setTimeout(()=>URL.revokeObjectURL(url), 4000);
  }

  // CSV parsing (quoted commas)
  function detectDelimiter(text) {
    const firstLine = (text.split(/\r?\n/).find(l => l.trim() !== '') || '');
    const candidates = [',',';','\t','|'];
    let best = ',', bestCount = -1;
    for (const d of candidates) {
      const c = firstLine.split(d).length;
      if (c > bestCount) { bestCount = c; best = d; }
    }
    return best;
  }

  function parseCSV(text, delimiter) {
    const out = [];
    let i = 0, field = '', row = [], inQuotes = false;

    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

    while (i < text.length) {
      const c = text[i];
      if (c === '"') {
        if (inQuotes && text[i+1] === '"') { field += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (c === delimiter && !inQuotes) {
        row.push(field); field = '';
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (field !== '' || row.length) { row.push(field); out.push(row); row = []; field = ''; }
        if (c === '\r' && text[i+1] === '\n') i++;
      } else {
        field += c;
      }
      i++;
    }
    if (field !== '' || row.length) { row.push(field); out.push(row); }
    return out;
  }

  function toObjects(matrix) {
    if (!matrix.length) return [];
    const headers = (matrix[0] || []).map(h => String(h ?? '').trim());
    const objects = [];
    for (let r = 1; r < matrix.length; r++) {
      const line = matrix[r];
      if (!line || !line.length) continue;
      if (line.join('').trim() === '') continue;
      const obj = {};
      for (let c = 0; c < headers.length; c++) obj[headers[c]] = (line[c] ?? '').trim();
      objects.push(obj);
    }
    return objects;
  }

  // =========================
  // LOAD CSV
  // =========================
  async function loadCSV(){
    setStatus(false, 'Loading‚Ä¶');
    setMeta('');
    rows = [];

    try{
      const url = CSV_URL + '?v=' + Date.now();
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);

      const lastModified = res.headers.get('last-modified');
      const etag = res.headers.get('etag');

      const text = await res.text();
      const delim = detectDelimiter(text);
      rows = toObjects(parseCSV(text, delim));

      setStatus(true, `Parsed ${rows.length} rows`);
      setMeta(`
        <div><strong>CSV file:</strong> <code>${esc(CSV_URL)}</code></div>
        <div><strong>CSV Last Updated (server):</strong> ${lastModified ? new Date(lastModified).toLocaleString() : '<span style="color:#7f1d1d;">Unknown</span>'}</div>
        <div><strong>Loaded at (this device):</strong> ${new Date().toLocaleString()}</div>
        ${etag ? `<div><strong>ETag:</strong> <code>${esc(etag)}</code></div>` : ''}
      `);

      const hasVid = rows.length ? (COL_VARIANT_ID in rows[0]) : false;
      debugEl.textContent = hasVid ? '' : `DEBUG: "${COL_VARIANT_ID}" column not found. Update COL_VARIANT_ID if your header differs.`;

      toast('CSV loaded');
    }catch(e){
      setStatus(false, `Couldn‚Äôt load ${CSV_URL} ‚Äî ${e.message}`);
      setMeta(`<div style="color:#7f1d1d;"><strong>Tip:</strong> Confirm <code>${esc(CSV_URL)}</code> exists in the repo root.</div>`);
      debugEl.textContent = 'DEBUG: CSV load failed.';
    }

    updateSummary();
  }

  function openCSV(){ window.open(CSV_URL, '_blank', 'noopener'); }

  // =========================
  // SCAN + LOOKUP
  // =========================
  scanEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const q = scanEl.value.trim();
      scanEl.value = '';
      lookup(q);
      setTimeout(()=>scanEl.focus(), 50);
    }
  });

  function lookup(q){
    if(!rows.length){
      resultEl.innerHTML = `<div class="badge bad">Not ready</div> Load the CSV first.`;
      return;
    }

    const m = rows.find(r =>
      (r[COL_BARCODE] && r[COL_BARCODE] === q) ||
      (r[COL_SKU] && r[COL_SKU] === q)
    );

    if(!m){
      resultEl.innerHTML = `<div class="badge bad">Not found</div>`;
      return;
    }

    const variantId = (m[COL_VARIANT_ID] || '').trim();
    const bin = (m[COL_BIN] || '‚Äî').trim();
    const title = (m[COL_TITLE] || '').trim();
    const barcode = (m[COL_BARCODE] || '').trim();
    const sku = (m[COL_SKU] || '').trim();

    activeVariantId = variantId;
    activeBarcode = barcode;
    activeSku = sku;

    const plyOn  = n(m[COL_PLY_ON]);
    const ghOn   = n(m[COL_GH_ON]);
    const plyMax = n(m[COL_PLY_MAX]);
    const ghMax  = n(m[COL_GH_MAX]);

    const plyNeed = Math.max(plyMax - plyOn, 0);
    const ghNeed  = Math.max(ghMax - ghOn, 0);

    const curMinPly = m[COL_PLY_MIN] ?? '';
    const curMaxPly = m[COL_PLY_MAX] ?? '';
    const curMinGh  = m[COL_GH_MIN] ?? '';
    const curMaxGh  = m[COL_GH_MAX] ?? '';
    const curWeight = m[COL_WEIGHT] ?? '';
    const curBin    = m[COL_BIN] ?? '';

    addPutaway(bin, barcode, title);

    const vidBadge = variantId
      ? `<span class="badge good">Variant ID OK</span>`
      : `<span class="badge bad">Missing Variant ID</span>`;

    resultEl.innerHTML = `
      <div class="grid">
        <div class="kpi">
          <div class="label">Plymouth Needed to Max</div>
          <div class="value">${plyNeed}</div>
          <div class="hint">Max ${esc(plyMax)} ‚Ä¢ On hand ${esc(plyOn)}</div>
        </div>
        <div class="kpi">
          <div class="label">Green Harbor Needed to Max</div>
          <div class="value">${ghNeed}</div>
          <div class="hint">Max ${esc(ghMax)} ‚Ä¢ On hand ${esc(ghOn)}</div>
        </div>
      </div>

      <div class="binline">WH Bin: <span style="font-weight:1000">${esc(bin)}</span></div>
      <div class="titleline">${esc(title)}</div>
      <div class="smallline">
        <strong>Barcode:</strong> ${esc(barcode)} &nbsp; | &nbsp;
        <strong>SKU:</strong> ${esc(sku)} &nbsp; | &nbsp;
        <strong>Variant ID:</strong> ${esc(variantId || '‚Äî')} &nbsp; ${vidBadge}
      </div>

      <div class="card" style="margin-top:12px;max-width:none;background:#f8fafc;border:1px solid #e2e8f0">
        <div style="font-weight:1000;margin-bottom:6px">Update Min/Max/Weight/Bin</div>
        <div class="sub" style="margin:0 0 10px 0">
          Leave blanks = <strong>no change</strong>. Exports contain only <strong>Variant ID</strong> + changed fields.
        </div>

        <div class="formRow">
          <div class="field"><label>WH Bin (current: ${esc(curBin)})</label><input id="u_bin" class="bin" value="" placeholder="(no change)"></div>

          <div class="field"><label>Min PLY (current: ${esc(curMinPly)})</label><input id="u_minply" value="" inputmode="numeric" placeholder="(no change)"></div>
          <div class="field"><label>Max PLY (current: ${esc(curMaxPly)})</label><input id="u_maxply" value="" inputmode="numeric" placeholder="(no change)"></div>
          <div class="field"><label>Min GH (current: ${esc(curMinGh)})</label><input id="u_mingh" value="" inputmode="numeric" placeholder="(no change)"></div>
          <div class="field"><label>Max GH (current: ${esc(curMaxGh)})</label><input id="u_maxgh" value="" inputmode="numeric" placeholder="(no change)"></div>

          <div class="field"><label>Variant Weight (current: ${esc(curWeight)})</label><input id="u_weight" class="wide" value="" placeholder="(no change)"></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <button id="btnQueue" type="button" class="primary"${variantId ? '' : ' disabled'}>Queue Update</button>
          <button id="btnRemove" type="button"${variantId ? '' : ' disabled'}>Remove Update</button>
        </div>

        <div class="debug" id="queueDebug">${variantId ? '' : 'Scan found but Variant ID is missing ‚Äî update exports require Variant ID.'}</div>
      </div>
    `;

    const qBtn = document.getElementById('btnQueue');
    const rBtn = document.getElementById('btnRemove');
    if(qBtn) qBtn.addEventListener('click', queueActiveUpdate);
    if(rBtn) rBtn.addEventListener('click', removeActiveUpdate);
  }

  // =========================
  // PUTAWAY
  // =========================
  function addPutaway(bin, barcode, title){
    const time = new Date();
    putaway.push({time, bin, barcode, title});

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(time.toLocaleTimeString())}</td>
      <td>${esc(bin)}</td>
      <td>${esc(barcode)}</td>
      <td>${esc(title)}</td>
    `;
    putawayTableEl.prepend(tr);
    updateSummary();
  }

  function clearPutaway(){
    putaway = [];
    putawayTableEl.innerHTML = '';
    resultEl.innerHTML = '';
    toast('Putaway cleared');
    updateSummary();
    scanEl.focus();
  }

  function downloadPutaway(){
    if(!putaway.length){
      setStatus(false, 'No putaway scans to export');
      return;
    }
    const sorted = [...putaway].sort((a,b) =>
      String(a.bin).localeCompare(String(b.bin), undefined, {numeric:true, sensitivity:'base'})
    );
    const rowsOut = [['bin','barcode','title']];
    for(const s of sorted){
      // preserve leading zeros in barcode for Excel
      const bc = s.barcode ? `="${String(s.barcode).replace(/"/g,'""')}"` : '';
      rowsOut.push([s.bin || '', bc, s.title || '']);
    }
    const csv = rowsOut.map(r => r.map(csvCell).join(',')).join('\n');
    saveCSV(csv, `putaway_report_${new Date().toISOString().slice(0,10)}.csv`);
  }

  // =========================
  // QUEUE UPDATES
  // =========================
  function queueActiveUpdate(){
    const dbg = document.getElementById('queueDebug');
    if(dbg) dbg.textContent = 'Queue Update clicked ‚úÖ';

    if(!activeVariantId){
      toast('Missing Variant ID ‚Äî cannot queue');
      if(dbg) dbg.textContent = 'Missing Variant ID ‚Äî cannot queue.';
      return;
    }

    const bin    = (document.getElementById('u_bin')?.value ?? '').trim();
    const minply = (document.getElementById('u_minply')?.value ?? '').trim();
    const maxply = (document.getElementById('u_maxply')?.value ?? '').trim();
    const mingh  = (document.getElementById('u_mingh')?.value ?? '').trim();
    const maxgh  = (document.getElementById('u_maxgh')?.value ?? '').trim();
    const weight = (document.getElementById('u_weight')?.value ?? '').trim();

    const obj = { variantId: activeVariantId };
    if(bin !== '')    obj.bin = bin;
    if(minply !== '') obj.minply = minply;
    if(maxply !== '') obj.maxply = maxply;
    if(mingh  !== '') obj.mingh  = mingh;
    if(maxgh  !== '') obj.maxgh  = maxgh;
    if(weight !== '') obj.weight = weight;

    const hasChange = Object.keys(obj).some(k => k !== 'variantId');
    if(!hasChange){
      toast('Nothing typed ‚Äî no update queued');
      if(dbg) dbg.textContent = 'Queue Update clicked ‚úÖ but nothing typed (no change).';
      return;
    }

    updates.set(activeVariantId, obj);
    renderUpdatesPreview();
    updateSummary();
    toast('Update queued');
    if(dbg) dbg.textContent = `Queued ‚úÖ (total queued: ${updates.size})`;
  }

  function removeActiveUpdate(){
    if(!activeVariantId) return;
    updates.delete(activeVariantId);
    renderUpdatesPreview();
    updateSummary();
    toast('Update removed');
  }

  function renderUpdatesPreview(){
    updatesTableEl.innerHTML = '';
    for(const u of updates.values()){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(u.variantId)}</td>
        <td>${esc(u.bin ?? '')}</td>
        <td>${esc(u.minply ?? '')}</td>
        <td>${esc(u.maxply ?? '')}</td>
        <td>${esc(u.mingh ?? '')}</td>
        <td>${esc(u.maxgh ?? '')}</td>
        <td>${esc(u.weight ?? '')}</td>
      `;
      updatesTableEl.appendChild(tr);
    }
  }

  // =========================
  // STREAMLINED EXPORTS
  // =========================

  // BIN Updates: EXACTLY 2 columns => Variant ID, BIN metafield column
  function downloadBinUpdates(){
    const items = [...updates.values()].filter(u => u.bin != null);
    if(items.length === 0){
      setStatus(false, 'No bin updates queued');
      return;
    }
    const out = [['Variant ID', COL_BIN]];
    for(const u of items){
      out.push([u.variantId, u.bin ?? '']);
    }
    const csv = out.map(r => r.map(csvCell).join(',')).join('\n');
    saveCSV(csv, `pickle_bin_updates_${new Date().toISOString().slice(0,10)}.csv`);
  }

  // WEIGHT Updates: EXACTLY 2 columns => Variant ID, Variant Weight
  function downloadWeightUpdates(){
    const items = [...updates.values()].filter(u => u.weight != null);
    if(items.length === 0){
      setStatus(false, 'No weight updates queued');
      return;
    }
    const out = [['Variant ID', COL_WEIGHT]];
    for(const u of items){
      out.push([u.variantId, u.weight ?? '']);
    }
    const csv = out.map(r => r.map(csvCell).join(',')).join('\n');
    saveCSV(csv, `pickle_weight_updates_${new Date().toISOString().slice(0,10)}.csv`);
  }

  // Min/Max Updates:
  // Header includes ONLY the min/max columns that were edited anywhere in the queue.
  function downloadMinMaxUpdates(){
    const items = [...updates.values()].filter(u =>
      u.minply!=null || u.maxply!=null || u.mingh!=null || u.maxgh!=null
    );
    if(items.length === 0){
      setStatus(false, 'No min/max updates queued');
      return;
    }

    const useMinPly = items.some(u => u.minply!=null);
    const useMaxPly = items.some(u => u.maxply!=null);
    const useMinGh  = items.some(u => u.mingh!=null);
    const useMaxGh  = items.some(u => u.maxgh!=null);

    const header = ['Variant ID'];
    if(useMinPly) header.push(COL_PLY_MIN);
    if(useMaxPly) header.push(COL_PLY_MAX);
    if(useMinGh)  header.push(COL_GH_MIN);
    if(useMaxGh)  header.push(COL_GH_MAX);

    const out = [header];

    for(const u of items){
      const row = [u.variantId];
      if(useMinPly) row.push(u.minply ?? '');
      if(useMaxPly) row.push(u.maxply ?? '');
      if(useMinGh)  row.push(u.mingh ?? '');
      if(useMaxGh)  row.push(u.maxgh ?? '');
      out.push(row);
    }

    const csv = out.map(r => r.map(csvCell).join(',')).join('\n');
    saveCSV(csv, `pickle_minmax_updates_${new Date().toISOString().slice(0,10)}.csv`);
  }

  // =========================
  // WIRE BUTTONS + BOOT
  // =========================
  btnReload.addEventListener('click', loadCSV);
  btnOpen.addEventListener('click', openCSV);
  btnClearPutaway.addEventListener('click', clearPutaway);
  btnPutaway.addEventListener('click', downloadPutaway);

  btnBin.addEventListener('click', downloadBinUpdates);
  btnWeight.addEventListener('click', downloadWeightUpdates);
  btnMinMax.addEventListener('click', downloadMinMaxUpdates);

  loadCSV();
  updateSummary();
</script>

</body>
</html>
