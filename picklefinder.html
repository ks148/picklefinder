<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PickleFinder</title>

<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#f7f9fc;margin:0;padding:20px}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;max-width:980px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
h1{margin:0 0 6px}
.sub{font-size:13px;color:#555;margin-bottom:14px}
input{font-size:22px;padding:10px;width:100%;border-radius:10px;border:1px solid #ccc}
.bin{font-size:56px;font-weight:800;margin:12px 0}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
.good{background:#dcfce7;color:#166534}
.bad{background:#fee2e2;color:#7f1d1d}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
tbody tr:nth-child(even){background:#f9fafb}
button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;font-weight:700;cursor:pointer}
.hidden{display:none}
</style>
</head>

<body>

<h1>PickleFinder</h1>
<p class="sub">Auto-loads <strong>bin-locations.csv</strong> from this site</p>

<div class="card">
  <div id="status"><span class="badge bad">Not loaded</span></div>
  <button onclick="loadCSV()">Reload from site</button>
  <input id="fileInput" type="file" accept=".csv" class="hidden">
</div>

<div class="card">
  <input id="scan" placeholder="Scan barcode or SKU and press Enter" autofocus>
  <div id="result"></div>
</div>

<div class="card">
  <button onclick="clearLog()">Clear Log</button>
  <table>
    <thead><tr><th>Time</th><th>Bin</th><th>Barcode</th><th>Title</th></tr></thead>
    <tbody id="log"></tbody>
  </table>
</div>

<script>
const CSV_URL = './bin-locations.csv';
const COL_BARCODE = 'Variant Barcode';
const COL_SKU = 'Variant SKU';
const COL_TITLE = 'Title';
const COL_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

let rows = [];

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  const headers = lines.shift().split(',').map(h => h.replace(/^"|"$/g,''));
  return lines.map(l => {
    const cells = l.split(',').map(c => c.replace(/^"|"$/g,''));
    let o = {};
    headers.forEach((h,i)=>o[h]=cells[i]||'');
    return o;
  });
}

async function loadCSV(){
  try{
    const r = await fetch(CSV_URL + '?v=' + Date.now(), {cache:'no-store'});
    const t = await r.text();
    rows = parseCSV(t);
    document.getElementById('status').innerHTML =
      `<span class="badge good">Loaded</span> Parsed ${rows.length} rows`;
  }catch(e){
    document.getElementById('status').innerHTML =
      `<span class="badge bad">Failed</span> ${e.message}`;
  }
}

document.getElementById('scan').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const q = e.target.value.trim();
    e.target.value='';
    lookup(q);
  }
});

function lookup(q){
  const m = rows.find(r => r[COL_BARCODE]===q || r[COL_SKU]===q);
  if(!m){
    document.getElementById('result').innerHTML='<div class="badge bad">Not found</div>';
    return;
  }
  document.getElementById('result').innerHTML=
    `<div class="bin">${m[COL_BIN]||'â€”'}</div>
     <div><strong>${m[COL_TITLE]||''}</strong></div>`;
  addLog(m);
}

function addLog(m){
  const tr = document.createElement('tr');
  tr.innerHTML =
    `<td>${new Date().toLocaleTimeString()}</td>
     <td>${m[COL_BIN]||''}</td>
     <td>${m[COL_BARCODE]||''}</td>
     <td>${m[COL_TITLE]||''}</td>`;
  document.getElementById('log').prepend(tr);
}

function clearLog(){ document.getElementById('log').innerHTML=''; }

loadCSV();
</script>

</body>
</html>
